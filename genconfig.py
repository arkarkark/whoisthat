#!/usr/bin/python

import codecs
import logging
import os
import re
import textwrap
import urllib2
import urlparse
import HTMLParser

# visit http://www.looker.com/company and save as whole page Company.html

IMAGE_DIR = 'img'

def Main():
  """Make a config from a html file."""
  logging.basicConfig()
  logging.getLogger().setLevel(logging.DEBUG)
  unescape = HTMLParser.HTMLParser().unescape
  base = 'http://www.looker.com/company/team'

  if not os.path.exists(IMAGE_DIR):
    logging.info("Making image dir: %r", IMAGE_DIR)
    os.mkdir(IMAGE_DIR)

  print '// Auto generated by genconfig.py'
  print 'var peepsData = ['

  for line in urllib2.urlopen(base):
    if 'data-role' in line:
      peep = {}
      for attr in re.findall(r'([a-z_]+)="([^"]*)"', line, re.IGNORECASE): # "
        peep[attr[0]] = unescape(unicode(attr[1], 'utf-8'))
      peep['img'] = os.path.join(IMAGE_DIR, os.path.basename(peep['src']))
      if not os.path.exists(peep['img']):
        logging.info('Fetching missing image: %s', peep['src'])
        src = urlparse.urljoin(base, peep['src'])
        open(peep['img'], 'w').write(urllib2.urlopen(src).read())
      print "['%(img)s', '%(alt)s', '%(role)s']," % peep

  print textwrap.dedent("""
      ];

      var faviconUrl = '%(IMAGE_DIR)s/favicon.ico';
      var pageTitle = 'Looker\\'s lookers lookeraterer';
      var pageHeader = '<img src="%(IMAGE_DIR)s/logo.png">\\'s <img src="%(IMAGE_DIR)s/logo.png">s <img src="%(IMAGE_DIR)s/logo.png">aterer';

      var femaleNames = ('carolyn,lara,elfe,margaret,lissa,elena,anika,sara,emi,courtney,jenny,laura,' +
          'jeanne,esther,nicole,lindsey,erin,kendra,kimberly,abby,brie,amber,angela,kelly,alisa,haarthi,' +
          'pansy,avery,katherine,megan,jen,jennifer,renee,caitlin,grace,daina,melinda').split(',');


      module = module || {};
      module.exports = module.exports || {};

      module.exports.getPeepsData = function() {
        return peepsData;
      }
      """ % {"IMAGE_DIR": IMAGE_DIR})

  logging.info('rsync -avub --exclude .git ./ ~/Google\\ Drive/Public/lookeraterer/')

if __name__ == '__main__':
  Main()
